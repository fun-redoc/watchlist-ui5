"use strict";sap.ui.define(["sap/ui/core/UIComponent","./services/DBManager","sap/ui/model/base/ManagedObjectModel","./managedobject/MOWatchStock","./services/yFinApiService","./services/cacheService","sap/ui/Device"],function(t,e,o,n,s,i,c){"use strict";function a(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const r=e["mkDBManager"];const l=a(n);const u=s["api_getAssetBatch"];const h=a(i);const p="watchlistUI5DB";const d="watchlistUI5Store";const g=2;const y=t.extend("rsh.watchlist.ui5.AppComponent",{constructor:function e(){t.prototype.constructor.apply(this,arguments);this.yFinPool=new Promise(t=>t({}))},metadata:{manifest:"json",aggregations:{watchlist:{type:"rsh.watchlist.ui5.managedobject.MOWatchStock",singularName:"watchstock",multiple:true,bindable:true}},properties:{deviceType:{type:"string",bindable:true,defaultValue:"Phone",visibility:"public"},deviceIsNotTouch:{type:"boolean",bindable:true,defaultValue:false,visibility:"public"},deviceIsTouch:{type:"boolean",bindable:true,defaultValue:false,visibility:"public"},apiKey:{type:"string",bindable:true,defaultValue:"",visibility:"public"},useCache:{type:"boolean",bindable:true,defaultValue:false,visibility:"public"},cacheInterval:{type:"sap.ui.model.type.Integer",bindable:true,defaultValue:15,visibility:"public"}},defaultAggregation:"watchlist"},getI18nResourceBundle:async function t(){if(this.i18nResourceBundle)return this.i18nResourceBundle;const e=this.getModel("i18n");this.i18nResourceBundle=e.getResourceBundle();return this.i18nResourceBundle},init:function e(){t.prototype.init.call(this);this.setModel(new o(this),"component");this.getModel("component")?.setDefaultBindingMode("TwoWay");const n=this.getModel("component");n.setProperty("/deviceType",c.media.getCurrentRange("Std").name);n.setProperty("/deviceIsTouch",c.support.touch);n.setProperty("/deviceIsNotTouch",!c.support.touch);this.getRouter().initialize();this.loadSettings();this.loadWatchlistFromIndexDB()},destroy:function t(e){console.log("AppComonent destroy")},onDeactivate:function t(){console.log("AppComonent onDeactivate")},onActivate:function t(){console.log("AppComonent onActivate")},saveSettings:function t(e,o,n){const s=this.getModel("component");s.setProperty("/apiKey",e);s.setProperty("/useCache",o);if(n){s.setProperty("/cacheInterval",n)}setTimeout(()=>{localStorage.setItem(y.API_KEY_STORAGE_ID,e);localStorage.setItem(y.USE_CACHE_STORAGE_ID,`${o}`);if(n){localStorage.setItem(y.CACHE_INTERVAL_STORAGE_ID,`${n}`)}})},loadSettings:function t(){const e=localStorage.getItem(y.API_KEY_STORAGE_ID);const o=localStorage.getItem(y.USE_CACHE_STORAGE_ID);const n=o==="true";const s=localStorage.getItem(y.CACHE_INTERVAL_STORAGE_ID);const i=Number.parseInt(s);const c=this.getModel("component");c.setProperty("/apiKey",e);c.setProperty("/useCache",n);if(i){c.setProperty("/cacheInterval",i)}},getWatchDBM:async function t(){return await this.dbm},loadWatchlistFromIndexDB:async function t(){this.destroyAggregation("component",true);const e=this;this.dbm=r(p,d,g,[{indexName:"symbol",isUnique:true}]);this.dbm.then(t=>t.list()).then(t=>{t.map(t=>{const o=new l;o.setProperty("symbol",t.symbol);o.setProperty("name",t.name);o.setAggregation("watchSince",t.watchSince);e.addAggregation("watchlist",o)})});this.getModel("component")?.refresh()},addToWatch:async function t(e){try{const t=await this.getWatchDBM();const o=await t.add(e);const n=new l;n.setProperty("symbol",e.symbol);n.setProperty("name",e.name);n.setAggregation("watchSince",e.watchSince);this.addAggregation("watchlist",n);this.getModel("component")?.refresh()}catch(t){console.error(t);return new Promise((e,o)=>o(t))}},addToYFinPool:async function t(e,o){const n=this.yFinPool.then(t=>{e.forEach(e=>{if(e){if(!t[e]){t[e]={filter:[o]}}else{if(!t[e].filter){t[e]={filter:[o]}}else{t[e].filter.push(o)}}}});return t});this.yFinPool=n;await this.refreshYFinPool()},getYFinPool:function t(){return this.yFinPool},refreshYFinPool:async function t(){const e=this.getProperty("apiKey");if(!e){return}const o=await this.yFinPool;const n=Object.keys(o);const s=Object.values(o).reduce((t,e)=>{t[e.symbol]=e.filter;return t},{});console.log("symbolsToFetch=",n);const i=await this.fetchFromYFin(n);const c=i.reduce((t,e)=>{t[e.symbol]={...e,filter:s[e.symbol]};return t},{});this.yFinPool=new Promise(t=>t(c))},fetchFromYFin:async function t(e){const o=this.getProperty("apiKey");const n=this.getProperty("useCache");const s=this.getProperty("cacheInterval");if(!o){return[]}if(n){console.log("Component:fetchFromYFin:doUseCache:",n);console.log("Component:fetchFromYFin:cacheInterval:",s);const t=u(o);const c=t.fetchBatch;const a=h(c,{timeOutMillis:s});let r=[];for(var i=0;i<e.length;){const o=Math.min(e.length,i+t.MAX_BATCH_SIZE);const n=e.slice(i,o);i=o;let s=await a([n,undefined]);r=r.concat(s)}return r}else{console.log("Component:fetchFromYFin:doUseCache:",n);const t=u(o);let s=[];for(var i=0;i<e.length;){const o=Math.min(e.length,i+t.MAX_BATCH_SIZE);const n=e.slice(i,o);i=o;let c=await t.fetchBatch(n,undefined);s=s.concat(c)}return s}},refreshWatchlistMarketData:async function t(){const e=this.getProperty("apiKey");if(e){const t=this.getWatchlist();const n=t.reduce((t,e)=>{const o=e.getProperty("symbol");t[o]=e;return t},{});const s=Object.keys(n);const i=u(e);const c=i.fetchBatch;const a=h(c,{timeOutMillis:1e3*60*5});for(var o=0;o<s.length;){const t=Math.min(s.length,o+i.MAX_BATCH_SIZE);const e=s.slice(o,t);o=t;i.fetchBatch(e,undefined).then(t=>{t.forEach(t=>{const e=n[t.symbol];if(e){this.updateFromQuote(e,t)}else{console.warn(`no watch managed object found for ${t.symbol}`)}})})}}},updateFromQuote:function t(e,o){const n=e.getMetadata().getAllProperties();const s=Object.keys(n);const i=o;s.forEach(t=>{if(i[t]){e.setProperty(t,i[t])}})},getWatchlist:function t(){return this.getAggregation("watchlist")}});y.API_KEY_STORAGE_ID="apiKeyInput";y.USE_CACHE_STORAGE_ID="useCache";y.CACHE_INTERVAL_STORAGE_ID="cacheInterval";y.DB_NAME_WATCHLIST=p;y.DB_STORE_WATCHLIST=d;y.DB_VERSION_WATCHLIST=g;return y});
//# sourceMappingURL=Component.js.map