"use strict";sap.ui.define(["sap/ui/core/UIComponent","./services/DBManager","sap/ui/model/base/ManagedObjectModel","./managedobject/MOWatchStock","./services/yFinApiService","./services/cacheService","sap/ui/Device"],function(t,e,n,o,i,s,c){"use strict";function a(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const r=e["mkDBManager"];const l=a(o);const h=i["api_getAssetBatch"];const u=a(s);const d="watchlistUI5DB";const g="watchlistUI5Store";const f=2;const y=t.extend("rsh.watchlist.ui5.AppComponent",{constructor:function e(){t.prototype.constructor.apply(this,arguments);this.yFinPool=new Promise(t=>t({}))},metadata:{manifest:"json",aggregations:{watchlist:{type:"rsh.watchlist.ui5.managedobject.MOWatchStock",singularName:"watchstock",multiple:true,bindable:true}},properties:{deviceType:{type:"string",bindable:true,defaultValue:"Phone",visibility:"public"}},defaultAggregation:"watchlist"},getI18nResourceBundle:async function t(){if(this.i18nResourceBundle)return this.i18nResourceBundle;const e=this.getModel("i18n");this.i18nResourceBundle=e.getResourceBundle();return this.i18nResourceBundle},init:function e(){t.prototype.init.call(this);this.setModel(new n(this),"component");this.getModel("component")?.setDefaultBindingMode("TwoWay");const o=this.getModel("component");o.setProperty("/deviceType",c.media.getCurrentRange("Std").name);this.getRouter().initialize();this.apiKey=localStorage.getItem(y.API_KEY_STORAGE_ID);this.loadWatchlistFromIndexDB()},destroy:function t(e){console.log("AppComonent destroy")},onDeactivate:function t(){console.log("AppComonent onDeactivate")},onActivate:function t(){console.log("AppComonent onActivate")},saveApiKey:function t(e){this.apiKey;localStorage.setItem(y.API_KEY_STORAGE_ID,e)},getApiKey:function t(){return this.apiKey},getWatchDBM:async function t(){return await this.dbm},loadWatchlistFromIndexDB:async function t(){this.destroyAggregation("component",true);const e=this;this.dbm=r(d,g,f,[{indexName:"symbol",isUnique:true}]);this.dbm.then(t=>t.list()).then(t=>{t.map(t=>{const n=new l;n.setProperty("symbol",t.symbol);n.setProperty("name",t.name);n.setAggregation("watchSince",t.watchSince);e.addAggregation("watchlist",n)})});this.getModel("component")?.refresh()},addToWatch:async function t(e){try{const t=await this.getWatchDBM();const n=await t.add(e);const o=new l;o.setProperty("symbol",e.symbol);o.setProperty("name",e.name);o.setAggregation("watchSince",e.watchSince);this.addAggregation("watchlist",o);this.getModel("component")?.refresh()}catch(t){console.error(t);return new Promise((e,n)=>n(t))}},addToYFinPool:async function t(e,n){const o=this.yFinPool.then(t=>{e.forEach(e=>{if(e){if(!t[e]){t[e]={filter:[n]}}else{if(!t[e].filter){t[e]={filter:[n]}}else{t[e].filter.push(n)}}}});return t});this.yFinPool=o;await this.refreshYFinPool()},getYFinPool:function t(){return this.yFinPool},refreshYFinPool:async function t(){if(!this.apiKey){return}const e=await this.yFinPool;const n=Object.keys(e);const o=Object.values(e).reduce((t,e)=>{t[e.symbol]=e.filter;return t},{});console.log("symbolsToFetch=",n);const i=await this.fetchFromYFin(n);const s=i.reduce((t,e)=>{t[e.symbol]={...e,filter:o[e.symbol]};return t},{});this.yFinPool=new Promise(t=>t(s))},fetchFromYFin:async function t(e){if(!this.apiKey){return[]}const n=h(this.apiKey);const o=n.fetchBatch;const i=u(o,{timeOutMillis:1e3*60*5});let s=[];for(var c=0;c<e.length;){const t=Math.min(e.length,c+n.MAX_BATCH_SIZE);const o=e.slice(c,t);c=t;let a=await i([o,undefined]);s=s.concat(a)}return s},refreshWatchlistMarketData:async function t(){if(this.apiKey){const t=this.getWatchlist();const n=t.reduce((t,e)=>{const n=e.getProperty("symbol");t[n]=e;return t},{});const o=Object.keys(n);const i=h(this.apiKey);const s=i.fetchBatch;const c=u(s,{timeOutMillis:1e3*60*5});for(var e=0;e<o.length;){const t=Math.min(o.length,e+i.MAX_BATCH_SIZE);const s=o.slice(e,t);e=t;i.fetchBatch(s,undefined).then(t=>{t.forEach(t=>{const e=n[t.symbol];if(e){this.updateFromQuote(e,t)}else{console.warn(`no watch managed object found for ${t.symbol}`)}})})}}},updateFromQuote:function t(e,n){const o=e.getMetadata().getAllProperties();const i=Object.keys(o);const s=n;i.forEach(t=>{if(s[t]){e.setProperty(t,s[t])}})},getWatchlist:function t(){return this.getAggregation("watchlist")}});y.API_KEY_STORAGE_ID="apiKeyInput";y.DB_NAME_WATCHLIST=d;y.DB_STORE_WATCHLIST=g;y.DB_VERSION_WATCHLIST=f;return y});
//# sourceMappingURL=Component.js.map