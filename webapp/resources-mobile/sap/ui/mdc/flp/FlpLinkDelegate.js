/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/Lib","sap/ui/mdc/LinkDelegate","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/Factory","sap/ui/mdc/link/Log","sap/base/Log","sap/base/util/isPlainObject","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/ui/mdc/enums/LinkType"],(e,t,n,i,a,c,o,r,s,u,l,f)=>{"use strict";const m=Object.assign({},n);m.fetchLinkItems=function(e,t,n){const i=e.getPayload();const a=t?t.getObject(t.getPath()):undefined;const o=[];if(n){n.initialize(m._getSemanticObjects(i));o.forEach(e=>{n.addIntent(c.IntentType.API,{text:e.getText(),intent:e.getHref()})})}const r=m._calculateSemanticAttributes(a,i,n);return m._retrieveNavigationTargets("",r,i,n).then((e,t)=>Promise.resolve(e))};m.fetchLinkType=function(e){const t={};let n=null;const i=e.getPayload();const c=function(e){return e.filter(e=>!t[e]).length===0};const r=function(e){return e.some(e=>t[e]&&t[e].exists===true)};const s=function(){if(!n){n=new Promise(e=>{const i=a.getService("CrossApplicationNavigation");if(!i){o.error("FlpLinkDelegate: Service 'CrossApplicationNavigation' could not be obtained");e({});return}i.getDistinctSemanticObjects().then(i=>{i.forEach(e=>{t[e]={exists:true}});n=null;return e(t)},()=>{o.error("FlpLinkDelegate: getDistinctSemanticObjects() of service 'CrossApplicationNavigation' failed");return e({})})})}return n};const u=function(e){if(c(e)){return Promise.resolve(r(e))}return s().then(()=>r(e))};if(i&&i.semanticObjects){return u(i.semanticObjects).then(e=>Promise.resolve({type:e?f.Popover:f.Text,directLink:undefined}))}else{throw new Error("no payload or semanticObjects found")}};m._calculateSemanticAttributes=function(e,t,n){const i=m._getSemanticObjects(t);const a=m._convertSemanticObjectMapping(m._getSemanticObjectMappings(t));if(!i.length){i.push("")}const c={};i.forEach(t=>{if(n){n.addContextObject(t,e)}c[t]={};for(const i in e){let s=null,u=null;if(n){s=n.getSemanticObjectAttribute(t,i);if(!s){s=n.createAttributeStructure();n.addSemanticObjectAttribute(t,i,s)}}if(e[i]===undefined||e[i]===null){if(s){s.transformations.push({value:undefined,description:"â„¹ Undefined and null values have been removed in FlpLinkDelegate."})}continue}if(r(e[i])){if(s){s.transformations.push({value:undefined,description:"â„¹ Plain objects has been removed in FlpLinkDelegate."})}continue}const l=a&&a[t]&&a[t][i]?a[t][i]:i;if(s&&i!==l){u={value:undefined,description:"â„¹ The attribute "+i+" has been renamed to "+l+" in FlpLinkDelegate.",reason:"ðŸ”´ A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+t+" with source attribute "+i+" and target attribute "+l+". You can modify the annotation if the mapping result is not what you expected."}}if(c[t][l]){o.error("FlpLinkDelegate: The attribute "+i+" can not be renamed to the attribute "+l+" due to a clash situation. This can lead to wrong navigation later on.")}c[t][l]=e[i];if(s){if(u){s.transformations.push(u);const a=n.createAttributeStructure();a.transformations.push({value:e[i],description:"â„¹ The attribute "+l+" with the value "+e[i]+" has been added due to a mapping rule regarding the attribute "+i+" in FlpLinkDelegate."});n.addSemanticObjectAttribute(t,l,a)}}}});return c};m._retrieveNavigationTargets=function(n,c,r,s){if(!r.semanticObjects){return new Promise(e=>{e([])})}const u=r.semanticObjects;const l=r.sourceControl;const f={ownNavigation:undefined,availableActions:[]};return t.load({name:"sap.ui.fl"}).then(()=>new Promise(t=>{sap.ui.require(["sap/ui/fl/Utils"],b=>{const p=a.getService("CrossApplicationNavigation");const g=a.getService("URLParsing");if(!p||!g){o.error("FlpLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return t(f.availableActions,f.ownNavigation)}const d=e.getElementById(l);const h=b.getAppComponentForControl(d);const v=u.map(e=>[{semanticObject:e,params:c?c[e]:undefined,appStateKey:n,ui5Component:h,sortResultsBy:"text"}]);return new Promise(()=>{p.getLinks(v).then(e=>{if(!e||!e.length){return t(f.availableActions,f.ownNavigation)}const n=m._getSemanticObjectUnavailableActions(r);const a=m._convertSemanticObjectUnavailableAction(n);let c=p.hrefForExternal();if(c&&c.indexOf("?")!==-1){c=c.split("?")[0]}if(c){c+="?"}const o=function(e,t){return!!a&&!!a[e]&&a[e].indexOf(t)>-1};const l=function(e){const t=g.parseShellHash(e.intent);if(o(t.semanticObject,t.action)){return}const n=p.hrefForExternal({target:{shellHash:e.intent}},h);if(e.intent&&e.intent.indexOf(c)===0){f.ownNavigation=new i({href:n,text:e.text,internalHref:e.intent});return}const a=new i({key:t.semanticObject&&t.action?t.semanticObject+"-"+t.action:undefined,text:e.text,description:undefined,href:n,internalHref:e.intent,icon:undefined,initiallyVisible:e.tags&&e.tags.indexOf("superiorAction")>-1});f.availableActions.push(a);if(s){s.addSemanticObjectIntent(t.semanticObject,{intent:a.getHref(),text:a.getText()})}};for(let t=0;t<u.length;t++){e[t][0].forEach(l)}return t(f.availableActions,f.ownNavigation)},()=>{o.error("FlpLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");return t(f.availableActions,f.ownNavigation)})})})}))};m._getSemanticObjects=function(e){return e.semanticObjects?e.semanticObjects:[]};m._getSemanticObjectUnavailableActions=function(e){const t=[];if(e.semanticObjectUnavailableActions){e.semanticObjectUnavailableActions.forEach(e=>{t.push(new l({semanticObject:e.semanticObject,actions:e.actions}))})}return t};m._getSemanticObjectMappings=function(e){const t=[];let n=[];if(e.semanticObjectMappings){e.semanticObjectMappings.forEach(e=>{n=[];if(e.items){e.items.forEach(e=>{n.push(new u({key:e.key,value:e.value}))})}t.push(new s({semanticObject:e.semanticObject,items:n}))})}return t};m._convertSemanticObjectMapping=function(e){if(!e.length){return undefined}const t={};e.forEach(e=>{if(!e.getSemanticObject()){throw Error("FlpLinkDelegate: 'semanticObject' property with value '"+e.getSemanticObject()+"' is not valid")}t[e.getSemanticObject()]=e.getItems().reduce((e,t)=>{e[t.getKey()]=t.getValue();return e},{})});return t};m._convertSemanticObjectUnavailableAction=function(e){if(!e.length){return undefined}const t={};e.forEach(e=>{if(!e.getSemanticObject()){throw Error("FlpLinkDelegate: 'semanticObject' property with value '"+e.getSemanticObject()+"' is not valid")}t[e.getSemanticObject()]=e.getActions()});return t};return m});
//# sourceMappingURL=FlpLinkDelegate.js.map