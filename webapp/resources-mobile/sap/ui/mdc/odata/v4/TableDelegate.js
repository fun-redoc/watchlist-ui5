/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../table/V4AnalyticsPropertyHelper","sap/ui/mdc/enums/TableP13nMode","sap/ui/mdc/enums/TableType","sap/ui/mdc/enums/TableSelectionMode","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/util/loadModules","sap/m/plugins/PluginBase","sap/ui/core/Lib","sap/ui/core/format/ListFormat","sap/ui/core/message/MessageType","sap/ui/base/ManagedObjectObserver"],(e,t,n,r,o,i,s,a,l,u,p,g)=>{"use strict";const c=new window.WeakMap;const f=Object.assign({},e);f.getTypeMap=function(e){return i};f.getPropertyHelperClass=function(){return t};f.updateBindingInfo=function(t,n){const r=t.getRowBinding()?.getAggregation();e.updateBindingInfo.apply(this,arguments);if("expandTo"in(r??{})){n.parameters.$$aggregation={expandTo:r.expandTo}}if(!E(t)){const e=P(t);if(e.length>0){const r=t.getPropertyHelper();n.parameters.$select=e.map(e=>r.getProperty(e).path)}}};f.getGroupSorter=function(t){const n=t._getGroupedProperties()[0];if(!n||!t._isOfType(r.ResponsiveTable)){return undefined}if(!S(t).includes(n.name)){return undefined}return e.getGroupSorter.apply(this,arguments)};f.getSorters=function(t){let n=e.getSorters.apply(this,arguments);if(E(t)){const e=t.getPropertyHelper();const r=S(t).map(t=>e.getProperty(t).path);n=n.filter(e=>r.includes(e.sPath))}return n};f.updateBinding=function(e,t,n,r){if(!n||n.getPath()!=t.path){this.rebind(e,t);return}const o=n.getRootBinding();let i=o&&!o.isSuspended();try{if(i){o.suspend()}if(E(e)){h(e,t)}else{n.setAggregation(t.parameters?.$$aggregation)}n.changeParameters((()=>{const e={...t.parameters};delete e.$$aggregation;return e})());n.filter(t.filters,"Application");n.sort(t.sorter);if(r&&r.forceRefresh){n.refresh()}}catch(r){this.rebind(e,t);if(o==n){i=false}}finally{if(i&&o.isSuspended()){o.resume()}}};f.rebind=function(t,n){h(t,n);e.rebind.apply(this,arguments)};f.expandAllRows=function(e){if(!this.getSupportedFeatures(e).expandAllRows){throw Error("Unsupported operation: Not supported for the current table type")}d(e,Number.MAX_SAFE_INTEGER)};f.collapseAllRows=function(e){if(!this.getSupportedFeatures(e).collapseAllRows){throw Error("Unsupported operation: Not supported for the current table type")}d(e,1)};function d(e,t){const n=e.getRowBinding();if(!n){return}const r=n.getAggregation()?.expandTo===t;if(r){n.refresh()}else{n.setAggregation({...n.getAggregation(),...{expandTo:t}})}}f.getInResultPropertyKeys=function(e){return[]};f.getSupportedFeatures=function(t){const o=e.getSupportedFeatures.apply(this,arguments);const i=t._isOfType(r.TreeTable);if(t._isOfType(r.Table)){const e=o.p13nModes;if(!e.includes(n.Group)){e.push(n.Group)}if(!e.includes(n.Aggregate)){e.push(n.Aggregate)}}return{...o,expandAllRows:i,collapseAllRows:i}};f.validateState=function(t,n,r){const o=e.validateState.apply(this,arguments);let i;if(r=="Sort"){i=m(t,n)}else if(r=="Group"){i=T(t,n)}else if(r=="Column"){i=y(t,n)}return C(o,i)};function m(e,t){if(E(e)&&v(e,t.items,t.sorters)){return{validation:p.Information,message:l.getResourceBundleFor("sap.ui.mdc").getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}}return null}function T(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");if(t.aggregations){const r=Object.keys(t.aggregations);const o=[];const i=u.getInstance();r.forEach(t=>{const n=e.getPropertyHelper().getProperty(t);if(n&&n.groupable){o.push(t)}});if(o.length>0){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_TOTALS",[i.format(o)])}}}else if(e._isOfType(r.ResponsiveTable)){if(v(e,t.items,t.groupLevels)){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}return null}function y(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");const o=t.aggregations&&Object.keys(t.aggregations);let i;if(e._isOfType(r.ResponsiveTable)){if(v(e,t.items,t.groupLevels)){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}if(v(e,t.items,o)){i=n.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION")}if(E(e)&&v(e,t.items,t.sorters)){const e=n.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION");i=i?i+"\n"+e:e}if(i){return{validation:p.Information,message:i}}return null}f.preInit=function(){return Promise.resolve()};f.initializeContent=function(t){return e.initializeContent.apply(this,arguments).then(()=>{if(!c.has(t)){c.set(t,{})}return N(t)}).then(()=>{h(t)})};f.initializeSelection=function(t){if(t._isOfType(r.Table,true)){return b(t)}else{return e.initializeSelection.apply(this,arguments)}};function b(e){const t={Single:"Single",SingleMaster:"Single",Multi:"MultiToggle"};return s("sap/ui/table/plugins/ODataV4Selection").then(n=>{const r=n[0];e._oTable.addDependent(new r({limit:"{$sap.ui.mdc.Table#type>/selectionLimit}",enableNotification:true,hideHeaderSelector:"{= !${$sap.ui.mdc.Table#type>/showHeaderSelector} }",selectionMode:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return t[e]}},enabled:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return e in t}},selectionChange:function(t){e._onSelectionChange({selectAll:t.getParameter("selectAll")})}}))})}f.setSelectedContexts=function(t,n){if(t._isOfType(r.Table,true)){const e=t.getSelectionMode();if(e===o.None||(e===o.Single||e===o.SingleMaster)&&n.length>1){throw Error("Unsupported operation: Cannot select the given number of contexts in the current selection mode")}t.clearSelection();for(const e of n){e.setSelected(true)}}else{e.setSelectedContexts.apply(this,arguments)}};f.getSelectedContexts=function(t){if(t._isOfType(r.Table,true)){return a.getPlugin(t._oTable,"sap.ui.table.plugins.ODataV4Selection")?.getSelectedContexts()??[]}return e.getSelectedContexts.apply(this,arguments)};function h(e,t){const n=c.get(e).plugin;if(!n||n.isDestroyed()){return}const r=Array.from(new Set([...S(e),...P(e)]));const o=e._getGroupedProperties().map(e=>e.name);const i=Object.keys(e._getAggregatedProperties());const s=I(e,i);const a=t?.parameters["$search"];if(a){delete t.parameters["$search"]}n.setAggregationInfo({visible:r,groupLevels:o,grandTotal:i,subtotals:i,columnState:s,search:a})}function S(e){return O(e,e.getColumns())}function P(e){return O(e,e.getControlDelegate().getInResultPropertyKeys(e))}function I(e,t){const n={};e.getColumns().forEach(r=>{let o=r.getId()+"-innerColumn";const i=R(e,r,t);const s=i.length>0;if(o in n){n[o].subtotals=s||n[o].subtotals;n[o].grandTotal=s||n[o].grandTotal;return}n[o]={subtotals:s,grandTotal:s};_(e,i).forEach(e=>{o=e.getId()+"-innerColumn";if(o in n){n[o].subtotals=s||n[o].subtotals;n[o].grandTotal=s||n[o].grandTotal}else{n[o]={subtotals:s,grandTotal:s}}})});return n}function O(e,t){const n=e.getPropertyHelper();const r=typeof t[0]==="object"?t.map(e=>e.getPropertyKey()):t;return Array.from(new Set(r.flatMap(e=>n.getProperty(e)?.getSimpleProperties().map(e=>e.key)||[])))}function A(e,t){const n=e.getPropertyHelper().getProperty(t.getPropertyKey());if(!n){return[]}else{return n.getSimpleProperties()}}function R(e,t,n){return A(e,t).filter(e=>n.includes(e.name))}function _(e,t){const n=[];t.forEach(e=>{if(e.unitProperty){n.push(e.unitProperty)}});return e.getColumns().filter(t=>A(e,t).some(e=>n.includes(e)))}function v(e,t,n){const r=[];if(t){t.forEach(t=>{e.getPropertyHelper().getProperty(t.name).getSimpleProperties().forEach(e=>{r.push(e.name)})})}const o=n?n.every(e=>r.find(t=>e.name?e.name===t:e===t)):true;return!o}function C(e,t){const n={Error:1,Warning:2,Information:3,None:4};if(!t||n[t.validation]-n[e.validation]>0){return e}else{return t}}function E(e){return e._isOfType(r.Table)&&(e.getGroupConditions()||e.isGroupingEnabled()||e.getAggregateConditions()||e.isAggregationEnabled())}function N(e){if(e._isOfType(r.Table)){return(E(e)?L(e):w(e)).then(()=>x(e))}return Promise.resolve()}function L(e){const t=c.get(e);let n=t.plugin;if(n&&!n.isDestroyed()){n.activate();return Promise.resolve()}return Promise.all([e.awaitPropertyHelper(),s("sap/ui/table/plugins/V4Aggregation")]).then(r=>{const o=r[1][0];const i=e.getControlDelegate();n=new o({groupHeaderFormatter:function(t,n){return i.formatGroupHeader(e,t,n)}});n.setPropertyInfos(e.getPropertyHelper().getPropertiesForPlugin());e.propertiesFinalized().then(()=>{n.setPropertyInfos(e.getPropertyHelper().getPropertiesForPlugin())});e._oTable.addDependent(n);t.plugin=n})}function w(e){const t=c.get(e);if(t.plugin){t.plugin.deactivate()}return Promise.resolve()}function x(e){const t=c.get(e);if(!t.observer){t.observer=new g(t=>{N(e)});t.observer.observe(e,{properties:["p13nMode","groupConditions","aggregateConditions"]})}}return f});
//# sourceMappingURL=TableDelegate.js.map